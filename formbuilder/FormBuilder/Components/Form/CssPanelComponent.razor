@using BlazorMonaco.Editor
@using FormBuilder.Controllers
@using FormBuilder.Helpers
@using System.Text.Json
@using System.Text
@using FormBuilder.Models
@using FormBuilder.Services
@using System.Text.Json.Nodes
@using static BlazorMonaco.Editor.Global

<RadzenStack>
    <RadzenDropDown Data="@AllTemplates" TextProperty="Name" @bind-Value="@SelectedTemplate" />
    <RadzenTabs @bind-SelectedIndex="@selectedIndex">
        <Tabs>
            <!-- CSS class names -->
            <RadzenTabsItem Text="CSS classes">
                <RadzenText TextStyle="TextStyle.Subtitle1">CSS classes</RadzenText>
                <hr />
                <StandaloneCodeEditor @ref=classesEditor OnDidInit="HandleOnClassesInit" OnDidChangeModelContent="HandleClassesOnEditorContentChanged" ConstructionOptions="EditorJsonConstructionOptions" CssClass="cssEditor" />
            </RadzenTabsItem>
            <!-- Javascript scripts -->
            <RadzenTabsItem Text="Javascript files">
                <!-- Javascript files -->
                <RadzenText TextStyle="TextStyle.Subtitle1">Files</RadzenText>
                <hr />
                <RadzenStack>
                    @foreach (var jsFile in SelectedTemplate.JsStyles.Where(j => j.Category == TemplateStyleCategories.Lib))
                    {
                        <RadzenFormField Text="URL">
                            <RadzenTextBox @bind-Value="@jsFile.Value" />
                        </RadzenFormField>
                    }
                </RadzenStack>
                <!-- Custom javascript script -->
                <RadzenText TextStyle="TextStyle.Subtitle1">Custom javascript script</RadzenText>
                <hr />
                <StandaloneCodeEditor @ref=customJsEditor OnDidInit="HandleOnCustomJsInit" OnDidChangeModelContent="HandleCustomJsOnEditorContentChanged" ConstructionOptions="EditorJsConstructionOptions" CssClass="cssEditor" />
            </RadzenTabsItem>
            <!-- CSS -->
            <RadzenTabsItem Text="CSS files">
                <!-- CSS files -->
                <RadzenText TextStyle="TextStyle.Subtitle1">Files</RadzenText>
                <hr />
                <RadzenStack>
                    @foreach (var cssFile in SelectedTemplate.CssStyles.Where(j => j.Category == TemplateStyleCategories.Lib))
                    {
                        <RadzenFormField Text="URL">
                            <RadzenTextBox @bind-Value="@cssFile.Value" />
                        </RadzenFormField>
                    }
                </RadzenStack>
                <!-- Custom css script-->
                <RadzenText TextStyle="TextStyle.Subtitle1">Custom css</RadzenText>
                <hr />
                <StandaloneCodeEditor @ref=customCssEditor OnDidInit="HandleOnCustomCssInit" OnDidChangeModelContent="@((e) => HandleCustomCssOnEditorContentChanged())" ConstructionOptions="EditorCssConstructionOptions" CssClass="cssEditor" />
            </RadzenTabsItem>
        </Tabs>
    </RadzenTabs>
    <RadzenButton Text="Save" Disabled="@isDisabled" Click="@(async () => await HandleSave())" ButtonStyle="ButtonStyle.Primary" class="fullWidth"></RadzenButton>
</RadzenStack>

@code {
    int selectedIndex = 0;
    private string _classes = "{}";
    private string _js = "";
    private string _css = "";
    private Template _template;
    private StandaloneCodeEditor classesEditor;
    private StandaloneCodeEditor customJsEditor;
    private StandaloneCodeEditor customCssEditor;
    private bool isDisabled { get; set; }
    private Template _selectedTemplate;
    [Parameter] public string FormId { get; set; }
    [Parameter] public List<Template> AllTemplates 
    { 
        get; set; 
    } = new List<Template>();
    [Parameter] public Template SelectedTemplate 
    {
        get 
        {
            return _selectedTemplate;
        }
        set
        {
            if(_selectedTemplate == value)
            {
                return;
            }

            _selectedTemplate = value;
            _classes = GetClasses();
            _js = GetJs();
            _css = GetCss();
            Refresh();
        }
    }
    [Parameter] public EventCallback<Template> SelectedTemplateChanged { get; set; }
    [Parameter] public EventCallback<ActionState<Template, bool>> TemplateSaved { get; set; }
    [Inject] public IJSRuntime jSRuntime { get; set; }
    [Inject] public NotificationService notificationService { get; set; }
    [Inject] public IFormBuilderJsService formBuilderJsService { get; set; }

    protected override void OnAfterRender(bool firstRender)
    {
        base.OnAfterRender(firstRender);
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
    }

    private async Task HandleOnClassesInit()
    {
        var json = GetClasses();
        if(json != null)
        {
            classesEditor.SetValue(json);
        }
    }

    private async Task HandleOnCustomJsInit()
    {
        var js = GetJs();
        if(js != null)
        {
            customJsEditor.SetValue(js);
        }
    }

    private async Task HandleOnCustomCssInit()
    {
        var css = GetCss();
        if(css != null)
        {
            customCssEditor.SetValue(css);
        }
    }

    private async Task HandleClassesOnEditorContentChanged()
    {
        var str = await classesEditor.GetValue();
        ApplyClasses(str);
        await SelectedTemplateChanged.InvokeAsync(SelectedTemplate);
    }

    private async Task HandleCustomJsOnEditorContentChanged()
    {
        var jsTemplateStyle = SelectedTemplate.JsStyles.SingleOrDefault(j => j.Category == TemplateStyleCategories.Custom);
        if(jsTemplateStyle == null)
        {
            return;
        }

        jsTemplateStyle.Value = await customJsEditor.GetValue();
        await SelectedTemplateChanged.InvokeAsync(SelectedTemplate);
    }

    private async Task HandleCustomCssOnEditorContentChanged()
    {
        var cssTemplateStyle = SelectedTemplate.CssStyles.SingleOrDefault(j => j.Category == TemplateStyleCategories.Custom);
        if(cssTemplateStyle == null)
        {
            return;
        }

        cssTemplateStyle.Value = await customCssEditor.GetValue();
        await SelectedTemplateChanged.InvokeAsync(SelectedTemplate);

    }

    private StandaloneEditorConstructionOptions EditorJsConstructionOptions(StandaloneCodeEditor editor)
    {
        return new StandaloneEditorConstructionOptions
        {
            AutomaticLayout = true,
            Language = "javascript",
            Value = _js
        };
    }

    private StandaloneEditorConstructionOptions EditorJsonConstructionOptions(StandaloneCodeEditor editor)
    {
        return new StandaloneEditorConstructionOptions
        {
            AutomaticLayout = true,
            Language = "json",
            Value = _classes
        };
    }

    private StandaloneEditorConstructionOptions EditorCssConstructionOptions(StandaloneCodeEditor editor)
    {
        return new StandaloneEditorConstructionOptions
        {
            AutomaticLayout = true,
            Language = "css",
            Value = _css
        };
    }

    private void Refresh()
    {
        if(selectedIndex == 0 && classesEditor != null)
        {
            classesEditor.SetValue(_classes);
        }
        else if(selectedIndex == 1 && customJsEditor != null)
        {
            customJsEditor.SetValue(_js);
        }
        else if(customCssEditor != null)
        {
            customCssEditor.SetValue(_css);
        }

        ApplyClasses(_classes);
        SelectedTemplateChanged.InvokeAsync(SelectedTemplate).Wait();
    }

    private string GetClasses()
    {
        if(classesEditor == null)
        {
            return null;
        }

        var json = new JsonObject();
        foreach (var grp in SelectedTemplate.Elements.GroupBy(e => e.Element))
        {
            var record = new JsonObject();
            foreach (var elt in grp.Select(_ => _))
            {
                record.Add(elt.Name, elt.Value);
            }

            json.Add(grp.Key, record);
        }

        var str = JsonSerializer.Serialize(json, new JsonSerializerOptions { WriteIndented = true });
        return str;
    }

    private string GetJs()
    {
        if (SelectedTemplate == null || customJsEditor == null)
        {
            return null;
        }

        var jsTemplateStyle = SelectedTemplate.JsStyles.SingleOrDefault(j => j.Category == TemplateStyleCategories.Custom);
        var js = jsTemplateStyle?.Value ?? "";
        return js;
    }

    private string GetCss()
    {
        if (SelectedTemplate == null || customCssEditor == null)
        {
            return null;
        }

        var cssTemplateStyle = SelectedTemplate.CssStyles.SingleOrDefault(j => j.Category == TemplateStyleCategories.Custom);
        var css = cssTemplateStyle?.Value ?? "";
        return css;
    }

    private void ApplyClasses(string str)
    {
        if(string.IsNullOrWhiteSpace(str))
        {
            return;
        }

        var json = JsonObject.Parse(str).AsObject();
        foreach (var elt in SelectedTemplate.Elements)
        {
            if (json.ContainsKey(elt.Element))
            {
                var record = json[elt.Element].AsObject();
                if (record.ContainsKey(elt.Name))
                {
                    elt.Value = record[elt.Name].ToString();
                }
            }
        }
    }

    private async Task HandleSave()
    {
        isDisabled = true;
        await TemplateSaved.InvokeAsync(new ActionState<Template, bool>(async (b) =>
        {
            notificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "The css style has been updated" });
            isDisabled = false;
        }, SelectedTemplate));
    }
}
