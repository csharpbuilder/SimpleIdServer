@using FormBuilder.Components.FormElements.ListData
@using FormBuilder.Factories
@using FormBuilder.Link
@using FormBuilder.Models
@using System.Text.Json
@using System.Text.Json.Nodes
@inject DialogService dialogService
@inject IWorkflowLinkActionFactory workflowLinkActionFactory

<RadzenStack>
    <RadzenFormField Variant="Variant.Outlined" Text="Choose the type action" class="fullWidth">
        <RadzenDropDown @bind-Value=@SelectedActionType Data="@actions" TextProperty="DisplayName" ValueProperty="Type" />
    </RadzenFormField>
    @CustomRender
    <RadzenButton Text="Save" Click="@HandleSave"></RadzenButton>
</RadzenStack>

@code {
    private string _selectedActionType;
    private WorkflowLink _copyWorkflowLink { get; set; }
    private object linkParameter { get; set; }
    private RenderFragment? CustomRender { get; set; }
    private List<IWorkflowLinkAction> actions { get; set; }
    private string SelectedActionType
    {
        get
        {
            return _copyWorkflowLink.ActionType;
        }
        set
        {
            _copyWorkflowLink.ActionType = value;
            CustomRender = CreateComponent();
        }
    }

    [Parameter] public WorkflowContext Context { get; set; }
    [Parameter] public WorkflowLink WorkflowLink { get; set; }
    [Inject] private IFakerDataServiceFactory fakerDataServiceFactory { get; set; }
    [Inject] private IFormElementTransformerFactory formElementTransformerFactory { get; set; }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        if(WorkflowLink != null && _copyWorkflowLink == null)
        {
            _copyWorkflowLink = WorkflowLink.Clone();
            if (_copyWorkflowLink.ActionType != null)
                SelectedActionType = _copyWorkflowLink.ActionType;
        }
    }

    protected override void OnAfterRender(bool firstRender)
    {
        base.OnAfterRender(firstRender);
        if (firstRender)
        {
            actions = workflowLinkActionFactory.GetAll(Context, WorkflowLink);
            CustomRender = CreateComponent();
            StateHasChanged();
        }
    }

    private RenderFragment CreateComponent() => builder =>
    {
        if (_copyWorkflowLink.ActionType == null) return;
        var workflowLinkAction = actions?.SingleOrDefault(a => a.Type == _copyWorkflowLink.ActionType);
        if (workflowLinkAction == null) return;
        var fakeData = GenerateFakeJson();
        linkParameter = workflowLinkAction.Render(builder, _copyWorkflowLink, fakeData, Context);
    };

    private void HandleSave()
    {
        WorkflowLink.ActionType = _copyWorkflowLink.ActionType;
        if(linkParameter != null) WorkflowLink.ActionParameter = JsonSerializer.Serialize(linkParameter);
        dialogService.Close();
    }

    private JsonNode GenerateFakeJson()
    {
        var step = Context.GetStepDefinition(_copyWorkflowLink.SourceStepId);
        var formEltRecord = Context.GetFormRecord(_copyWorkflowLink.Source.EltId);
        var stepRecord = Context.Definition.Records.Single(r => r.Id == step.FormRecordId);
        var fakeDataService = fakerDataServiceFactory.Build(stepRecord.Name);
        var input = JsonObject.Parse(JsonSerializer.Serialize(fakeDataService.Generate())).AsObject();
        return formElementTransformerFactory.Build(formEltRecord.Type)?.Transform(input, formEltRecord) ?? input;
    }
}