@using SimpleIdServer.IdServer.Website.Resources;
@using SimpleIdServer.IdServer.Website.Stores.AcrsStore;
@using SimpleIdServer.IdServer.Website.Stores.AuthMethodsStore;
@using SimpleIdServer.IdServer.Website.Stores.ClientStore
@using SimpleIdServer.IdServer.Website.Stores.IdServerConfigurationStore;
@inherits Fluxor.Blazor.Web.Components.FluxorComponent
@inject IState<AuthMethodsState> authMethodsStates
@inject NotificationService notificationService
@inject Radzen.DialogService dialogService
@inject IDispatcher dispatcher

<RadzenTemplateForm Submit=@SubmitClientSecret TItem="AddClientSecretForm" Data=@addClientSecret>
    <!-- Name -->
    <div>
        <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">@Global.ClientSecret</RadzenText>
        <RadzenPassword Name="Name" @bind-Value="@addClientSecret.Value" Class="w-100"></RadzenPassword>
        <RadzenRequiredValidator Component="Name" Text="@Global.ClientSecretRequired"></RadzenRequiredValidator>
    </div>
    <!-- Hash algorithm -->
    <div>
        <RadzenText TextStyle="TextStyle.Subtitle2" TagName="TagName.H3">@Global.DisplayName</RadzenText>
        <RadzenDropDown @bind-Value=@addClientSecret.Alg TValue="HashAlgs">
            <RadzenDropDownItem TValue="HashAlgs" Value="HashAlgs.PLAINTEXT" Text="PLAINTEXT" />
            <RadzenDropDownItem TValue="HashAlgs" Value="HashAlgs.MD5" Text="MD5" />
            <RadzenDropDownItem TValue="HashAlgs" Value="HashAlgs.SHA1" Text="SHA1" />
            <RadzenDropDownItem TValue="HashAlgs" Value="HashAlgs.SHA256" Text="SHA256" />
            <RadzenDropDownItem TValue="HashAlgs" Value="HashAlgs.SHA384" Text="SHA384" />
            <RadzenDropDownItem TValue="HashAlgs" Value="HashAlgs.SHA512" Text="SHA512" />
        </RadzenDropDown>
    </div>
    <RadzenButton class="mt-1" Variant="Variant.Flat" ButtonType="ButtonType.Submit" ButtonStyle="ButtonStyle.Success" Text="@(isAdding ? Global.Adding : Global.Add)" Disabled="@(isAdding)" />
</RadzenTemplateForm>

@code {
    [Parameter]
    public string Id { get; set; }
    bool isAdding { get; set; }
    record AddClientSecretForm
    {
        public string Value { get; set; }
        public HashAlgs Alg { get; set; }
        public DateTime? ExpirationTime { get; set; }
    }

    List<HashAlgDescription> HashAlgDescriptions = new List<HashAlgDescription>();

    AddClientSecretForm addClientSecret = new AddClientSecretForm();

    protected override void OnAfterRender(bool firstRender)
    {
        base.OnAfterRender(firstRender);
        if (firstRender)
        {
            SubscribeToAction<AddClientSecretSuccessAction>((act) =>
            {
                dialogService.Close();
                notificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = Global.ClientSecretAdded });
                StateHasChanged();
            });
        }
    }

    void SubmitClientSecret(AddClientSecretForm addClientSecretForm)
    {
        isAdding = true;
        dispatcher.Dispatch(new AddClientSecretAction
        {
            Alg = addClientSecretForm.Alg,
            Id = Id,
            Value = addClientSecretForm.Value
        });
    }

    private class HashAlgDescription
    {
        public string Name { get; set; }
        public HashAlgs Algs { get; set; }
    }
}